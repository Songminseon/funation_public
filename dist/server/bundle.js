!function(n){var e={};function t(o){if(e[o])return e[o].exports;var s=e[o]={i:o,l:!1,exports:{}};return n[o].call(s.exports,s,s.exports,t),s.l=!0,s.exports}t.m=n,t.c=e,t.d=function(n,e,o){t.o(n,e)||Object.defineProperty(n,e,{enumerable:!0,get:o})},t.r=function(n){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})},t.t=function(n,e){if(1&e&&(n=t(n)),8&e)return n;if(4&e&&"object"==typeof n&&n&&n.__esModule)return n;var o=Object.create(null);if(t.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:n}),2&e&&"string"!=typeof n)for(var s in n)t.d(o,s,function(e){return n[e]}.bind(null,s));return o},t.n=function(n){var e=n&&n.__esModule?function(){return n.default}:function(){return n};return t.d(e,"a",e),e},t.o=function(n,e){return Object.prototype.hasOwnProperty.call(n,e)},t.p="",t(t.s=9)}([function(n,e){n.exports=require("express")},function(n,e){n.exports=require("dotenv")},function(n,e){n.exports=require("mysql")},function(n,e){n.exports=require("passport")},function(n,e){n.exports=require("body-parser")},function(n,e){n.exports=require("csurf")},function(n,e,t){const o=t(8);n.exports=class extends o.Model{static init(n){return super.init({email:{type:o.STRING(40),allowNull:!0,unique:!0},nick:{type:o.STRING(15),allowNull:!1},provider:{type:o.STRING(10),allowNull:!1,defaultValue:"local"},snsId:{type:o.STRING(30),allowNull:!0},new_nickname:{type:o.STRING(10),allowNull:!0},new_photo:{type:o.STRING(200),allowNull:!0},created_at:{type:o.DATE,allowNull:!1,defaultValue:(new Date).setHours((new Date).getHours()+9)},age_range:{type:o.STRING(10),allowNull:!0},gender:{type:o.STRING(8),allowNull:!0},phone_number:{type:o.STRING(20),allowNull:!0},profile_img:{type:o.STRING(200),allowNull:!0},wallet:{type:o.INTEGER(20),allowNull:!0},level:{type:o.STRING(10),allowNull:!0},user_terms:{type:o.INTEGER(10),allowNull:!0},user_marketing:{type:o.INTEGER(10),allowNull:!0},new_nick:{type:o.STRING(45),allowNull:!0}},{sequelize:n,timestamps:!1,underscored:!1,modelName:"Users",tableName:"users",paranoid:!1,charset:"utf8",collate:"utf8_general_ci",dateStrings:"date",typeCast:!0})}static associate(n){}}},function(n,e){n.exports=require("path")},function(n,e){n.exports=require("sequelize")},function(n,e,t){(function(n){const e=t(0),o=e(),s=t(10),a=t(4),i=t(11),r=t(12),d=t(13),u=t(1),c={}.PORT||8080,l=t(14),_=t(3),{sequelize:g}=t(22),h=t(25),m=t(28),f=t(29),y=t(7);o.use(s()),o.use(a.json()),o.use(e.json()),o.use(e.urlencoded({extended:!1})),o.use(i("cookiesecret"));const E={resave:!1,saveUninitialized:!1,secret:"cookiesecret",cookie:{httpOnly:!0,secure:!1},proxy:!0};o.use(d(E)),o.use(_.initialize()),o.use(_.session()),o.use(l),o.use(e.static("dist")),o.get("*",(e,t)=>{t.sendFile(y.join(n,"../dist/index.html"))}),g.sync({force:!1}).then(()=>{console.log("db connect")}).catch(n=>{console.log(n)}),o.listen(c,()=>{console.log("Funation BackEnd server is on!!!"),console.log(y.join(n,"../dist"))}),u.config(),h(),o.use(r("combined")),o.use(m()),o.use(f())}).call(this,"/")},function(n,e){n.exports=require("cors")},function(n,e){n.exports=require("cookie-parser")},function(n,e){n.exports=require("morgan")},function(n,e){n.exports=require("cookie-session")},function(n,e,t){const o=t(0),s=(o(),o.Router()),a=t(15),i=t(16),r=t(17),d=t(19),u=t(21);s.use("/api",a),s.use("/auth",i),s.use("/function",r),s.use("/payments",d),s.use("/application",u),n.exports=s},function(n,e,t){const o=t(0),s=(o(),t(2)),a=o.Router();var i;t(1).config(),(i=s.createConnection({host:"funation.cjw8lfl5dvs6.ap-northeast-2.rds.amazonaws.com",user:"admin",port:"3306",password:"funation1234",database:"funation"})).connect((function(n){n?console.error("error connecting: "+n.stack):console.log("connected as id"+i.threadId)}));a.get("/users",(n,e)=>{i.query("SELECT * from user",(n,e)=>{console.log("good connect")})}),a.get("/getUserName",(n,e)=>{n.user?i.query("SELECT nick, profile_img FROM users WHERE snsId = ?",[n.user.snsId],(n,t)=>{n?console.log(n):e.json({name:t[0].nick,img:t[0].profile_img})}):e.json({name:"funation_guest",img:null})}),a.get("/searchAllDonation",(n,e)=>{i.query("SELECT sum(transaction_money) as money FROM donation_transaction",(n,t)=>{n?console.log(n):e.json({money:t[0]})})}),a.get("/searchPossibleThing/:category",(n,e)=>{var t=n.params.category;"done"===t?i.query("SELECT * FROM donation_thing WHERE thing_status = 2",(n,t)=>{n?console.log(n):e.json({product:t})}):"doing"===t?i.query("SELECT * FROM donation_thing WHERE thing_status = 1",(n,t)=>{n?console.log(n):e.json({product:t})}):i.query("SELECT * FROM donation_thing WHERE thing_status = 1 or thing_status=2 ORDER BY thing_status, set_index",(n,t)=>{n?console.log(n):e.json({product:t})})}),a.get("/searchDoneThing",(n,e)=>{i.query("SELECT * FROM donation_thing WHERE thing_target_money <= thing_crowd_money",(n,t)=>{0===t.length?e.json({}):e.json({product:t})})}),a.get("/searchZzimThing",(n,e)=>{n.user?i.query("SELECT * FROM zzim_list JOIN donation_thing ON zzim_list.thing_index=donation_thing.thing_index WHERE zzim_list.user_id = ?",[n.user.snsId],(function(n,t){n?console.log(n):e.json({product:t})})):e.json({product:[]})}),a.get("/isLogin",(n,e)=>{n.user?i.query("SELECT user_terms FROM users WHERE snsId = ?",[n.user.snsId],(n,t)=>{n?console.log(n):e.json({status:!0,agree:t[0].user_terms})}):e.json({status:!1,agree:!1})}),a.get("/",(n,e)=>e.json({developer:"송민선!!!"})),a.get("/searchMyDonationDid/:thing_category/:subCategory",(n,e)=>{var t=n.params.thing_category,o=n.params.subCategory;n.user?"giveandtake"===t?"doing"===o?i.query("SELECT thing_index, thing_status, transaction_money, transaction_index ,date_format(transaction_date, '%Y.%m.%d %H:%i:%s') as date_format, thing_name, thing_description ,set_index, thing_status, thing_img_name, thing_crowd_money, thing_target_money, order_id, brand FROM donation_transaction LEFT JOIN donation_thing ON donation_transaction.transaction_thing = donation_thing.thing_index LEFT JOIN users ON donation_transaction.user_id = users.snsId where users.snsId = ? and thing_index > 0 and thing_index < 126 and thing_status = 1 ORDER BY date_format DESC",[n.user.snsId],(function(n,t){n?console.log(n):e.json({product:t})})):"done"===o?i.query("SELECT thing_index, thing_status, transaction_money, transaction_index ,date_format(transaction_date, '%Y.%m.%d %H:%i:%s') as date_format, thing_name, thing_description ,set_index, thing_status, thing_img_name, thing_crowd_money, thing_target_money, order_id, brand FROM donation_transaction LEFT JOIN donation_thing ON donation_transaction.transaction_thing = donation_thing.thing_index LEFT JOIN users ON donation_transaction.user_id = users.snsId where users.snsId = ? and thing_index > 0 and thing_index < 126 and thing_status = 2 ORDER BY date_format DESC",[n.user.snsId],(function(n,t){n?console.log(n):e.json({product:t})})):i.query("SELECT thing_index, thing_status, transaction_money, transaction_index ,date_format(transaction_date, '%Y.%m.%d %H:%i:%s') as date_format, thing_name, thing_description ,set_index, thing_status, thing_img_name, thing_crowd_money, thing_target_money, order_id, brand FROM donation_transaction LEFT JOIN donation_thing ON donation_transaction.transaction_thing = donation_thing.thing_index LEFT JOIN users ON donation_transaction.user_id = users.snsId where users.snsId = ? and thing_index > 0 and thing_index < 126 ORDER BY date_format DESC",[n.user.snsId],(function(n,t){n?console.log(n):e.json({product:t})})):"gabang"===t?"doing"===o?i.query("SELECT thing_index, thing_status, transaction_money, transaction_index ,date_format(transaction_date, '%Y.%m.%d %H:%i:%s') as date_format, thing_name, thing_description ,set_index, thing_status, thing_img_name, thing_crowd_money, thing_target_money, order_id, brand FROM donation_transaction LEFT JOIN donation_thing ON donation_transaction.transaction_thing = donation_thing.thing_index LEFT JOIN users ON donation_transaction.user_id = users.snsId where users.snsId = ? and thing_index > 125 and thing_status=3 ORDER BY date_format DESC",[n.user.snsId],(function(n,t){n?console.log(n):e.json({product:t})})):"done"===o?i.query("SELECT thing_index, thing_status, transaction_money, transaction_index ,date_format(transaction_date, '%Y.%m.%d %H:%i:%s') as date_format, thing_name, thing_description ,set_index, thing_status, thing_img_name, thing_crowd_money, thing_target_money, order_id, brand FROM donation_transaction LEFT JOIN donation_thing ON donation_transaction.transaction_thing = donation_thing.thing_index LEFT JOIN users ON donation_transaction.user_id = users.snsId where users.snsId = ? and thing_index > 125 and thing_status=4 ORDER BY date_format DESC",[n.user.snsId],(function(n,t){n?console.log(n):e.json({product:t})})):i.query("SELECT thing_index, thing_status, transaction_money, transaction_index ,date_format(transaction_date, '%Y.%m.%d %H:%i:%s') as date_format, thing_name, thing_description ,set_index, thing_status, thing_img_name, thing_crowd_money, thing_target_money, order_id, brand FROM donation_transaction LEFT JOIN donation_thing ON donation_transaction.transaction_thing = donation_thing.thing_index LEFT JOIN users ON donation_transaction.user_id = users.snsId where users.snsId = ? and thing_index > 125 ORDER BY date_format DESC",[n.user.snsId],(function(n,t){n?console.log(n):e.json({product:t})})):"doing"===o?i.query("SELECT thing_index, thing_status, transaction_money, transaction_index ,date_format(transaction_date, '%Y.%m.%d %H:%i:%s') as date_format, thing_name, thing_description ,set_index, thing_status, thing_img_name, thing_crowd_money, thing_target_money, order_id, brand FROM donation_transaction LEFT JOIN donation_thing ON donation_transaction.transaction_thing = donation_thing.thing_index LEFT JOIN users ON donation_transaction.user_id = users.snsId where users.snsId = ? and (thing_status = 3 or thing_status = 1) ORDER BY date_format DESC",[n.user.snsId],(function(n,t){n?console.log(n):e.json({product:t})})):"done"===o?i.query("SELECT thing_index, thing_status, transaction_money, transaction_index ,date_format(transaction_date, '%Y.%m.%d %H:%i:%s') as date_format, thing_name, thing_description ,set_index, thing_status, thing_img_name, thing_crowd_money, thing_target_money, order_id, brand FROM donation_transaction LEFT JOIN donation_thing ON donation_transaction.transaction_thing = donation_thing.thing_index LEFT JOIN users ON donation_transaction.user_id = users.snsId where users.snsId = ?  and (thing_status = 4 or thing_status=2) ORDER BY date_format DESC",[n.user.snsId],(function(n,t){n?console.log(n):e.json({product:t})})):i.query("SELECT thing_index, thing_status, transaction_money, transaction_index ,date_format(transaction_date, '%Y.%m.%d %H:%i:%s') as date_format, thing_name, thing_description ,set_index, thing_status, thing_img_name, thing_crowd_money, thing_target_money, order_id, brand FROM donation_transaction LEFT JOIN donation_thing ON donation_transaction.transaction_thing = donation_thing.thing_index LEFT JOIN users ON donation_transaction.user_id = users.snsId where users.snsId = ? ORDER BY date_format DESC",[n.user.snsId],(function(n,t){n?console.log(n):e.json({product:t})})):e.json({product:[]})}),a.get("/searchSliderImg/:id",(function(n,e){i.query("SELECT * FROM slider_img where thing_index = ?",n.params.id,(function(n,t){n?console.log(n):e.json({img_resource:t})}))})),a.get("/searchAlarm",(function(n,e){n.user?i.query("SELECT *, date_format(alarm_date, '%Y.%m.%d') as date_format FROM user_alarm WHERE user_id = ? ORDER BY readOrNot, alarm_date DESC",[n.user.snsId],(function(n,t){n?console.log(n):0!==t.length?e.json({contents:t}):e.json({contents:null})})):e.json({contents:null})})),a.get("/searchMyDonation/:thing_index",(function(n,e){if(n.user){var t=n.params.thing_index;i.query("SELECT * FROM donation_transaction where user_id = ? and transaction_thing = ?",[n.user.snsId,t],(function(n,t){if(n)console.log(n);else{var o=0;for(var s in t)o+=t[s].transaction_money;var a=o/100;e.json({coin:a})}}))}else e.json({coin:0})})),a.get("/searchCurrentWallet",(function(n,e){n.user?i.query("SELECT wallet FROM users WHERE snsId = ?",[n.user.snsId],(function(n,t){n?console.log(n):e.json({wallet:t[0].wallet})})):e.json({wallet:0})})),a.get("/searchMyRecords",(function(n,e){var t=n.user.snsId;i.query("SELECT wallet_money, wallet_date, description,transaction_id as thing_img_name FROM wallet_transaction WHERE user_id = ? UNION SELECT transaction_money, transaction_date, thing_description, thing_img_name FROM donation_transaction JOIN donation_thing where donation_transaction.transaction_thing = donation_thing.thing_index and donation_transaction.user_id = ? ORDER BY wallet_date DESC",[t,t],(function(n,t){n?console.log(n):0!==t.length?e.json({records:t}):e.json({records:null})}))})),a.get("/searchSetPackage/:thing_index",(function(n,e){var t=n.params.thing_index;i.query("SELECT * FROM modal_thing WHERE thing_index = ?",[t],(function(n,t){n?console.log(n):e.json({resource:t})}))})),a.get("/searchAlarmCount",(function(n,e){n.user?i.query("SELECT count(*) as count FROM user_alarm where readOrNot=0 and user_id=?",[n.user.snsId],(function(n,t){n?console.log(n):e.json({count:t[0].count})})):e.json({count:0})})),a.get("/searchRecordByOrderNumber/:order_number",(function(n,e){var t=n.user.snsId,o=n.params.order_number;i.query("SELECT transaction_index, thing_status, thing_name, date_format(transaction_date, '%Y.%m.%d %H:%i:%s') as date_format, transaction_money, thing_description FROM donation_transaction JOIN donation_thing WHERE donation_transaction.transaction_thing = donation_thing.thing_index and user_id = ? and order_id = ?",[t,o],(function(n,t){n?console.log(n):e.json({resource:t})}))})),a.get("/amILucky/:thing_index",(function(n,e){var t=n.params.thing_index;n.user?i.query("SELECT * FROM donation_transaction JOIN result WHERE donation_transaction.transaction_thing = result.result_thing_index and result_thing_index = ? and donation_transaction.user_id = ?",[t,n.user.snsId],(function(t,o){t?console.log(t):0===o.length?e.json({status:null}):o[0].result_winner===n.user.snsId?e.json({status:"product"}):o[0].result_goods1===n.user.snsId||o[0].result_goods2===n.user.snsId?e.json({status:"goods"}):e.json({status:"donation"})})):e.json({status:null})})),a.get("/checkZzim/:thing_index",(n,e)=>{var t=n.params.thing_index;n.user?i.query("SELECT * FROM zzim_list WHERE thing_index=? and user_id=?",[t,n.user.snsId],(n,t)=>{n?console.log(n):0===t.length?e.json({isZzim:!1}):e.json({isZzim:!0})}):e.json({isZzim:!1})}),a.get("/getAmount/:set_index",(n,e)=>{var t=n.params.set_index;i.query("SELECT count(*) as total FROM donation_thing WHERE set_index = ? GROUP BY set_index",[t],(n,t)=>{n?console.log(n):e.json({total:t[0].total})})}),a.get("/getGabangMain",(n,e)=>{i.query("SELECT *, rank() over(ORDER BY thing_crowd_money DESC) AS ranking from donation_thing where brand=? ORDER BY thing_crowd_money DESC",["가방프로젝트"],(n,t)=>{n?console.log(n):e.json({info:t})})}),a.get("/getRanking/:thing_index",(n,e)=>{var t=n.params.thing_index;i.query("SELECT nick, snsId, sum(transaction_money) as total, rank() over(ORDER BY sum(transaction_money) DESC) as ranking from donation_transaction JOIN users where donation_transaction.user_id = users.snsId and donation_transaction.transaction_thing = ? GROUP BY snsId",[t],(t,o)=>{t?console.log(t):n.user?e.json({info:o,private_info:o.filter((function(e){return e.snsId===n.user.snsId}))}):e.json({info:o,private_info:"funation_guest"})})}),a.get("/checkGuest",(n,e)=>{n.user?e.json({guest:!1}):e.json({guest:!0})}),a.get("/searchGiveAndTake",(n,e)=>{i.query("SELECT sum(transaction_money) as money FROM donation_transaction where transaction_thing > -1 and transaction_thing < 126",(n,t)=>{n?console.log(n):e.json({money:t[0]})})}),a.get("/searchResult",(n,e)=>{i.query("SELECT * FROM result WHERE result_boolean = 0",(n,t)=>{n?console.log(n):e.json({data:t})})}),a.get("/searchGabang",(n,e)=>{i.query("SELECT sum(transaction_money) as money FROM donation_transaction WHERE transaction_thing>=126 and transaction_thing<=127",(n,t)=>{n?console.log(n):e.json({money:t[0]})})}),a.get("/getAdditional",(n,e)=>{n.user?i.query("SELECT phone_number, snsId, email FROM users WHERE snsId = ?",[n.user.snsId],(n,t)=>{n?console.log(n):e.json({phone_number:t[0].phone_number,snsId:t[0].snsId,email:t[0].email})}):e.json({snsId:"",phone_number:""})}),a.get("/checkUser",(n,e)=>{if(n.user){var t=n.user.snsId,o=n.user.created_at;i.query("SELECT nick ,transaction_money, created_at, profile_img, wallet FROM donation_transaction join users where donation_transaction.user_id = users.snsId and donation_transaction.user_id = ?;",t,(t,s)=>{if(t)console.log(t);else{console.log(s);var a=0,i=Math.ceil(((new Date).getTime()-new Date(o).getTime())/864e5);for(var r in s)a+=s[r].transaction_money;e.json({nick:n.user.nick,signDate:i,myDonationMoney:a,myDonationCount:s.length,profile_img:n.user.profile_img,wallet:n.user.wallet,guest:!1})}})}else e.json({nick:"",signDate:"0",donationMoney:"0",donationCount:"0",guest:!0})}),n.exports=a},function(n,e,t){const o=t(0),s=t(3),a=o.Router(),i=t(5)({cookie:!0});a.get("/kakao",s.authenticate("kakao")),a.get("/kakao/callback",s.authenticate("kakao",{failureRedirect:"http://do.funation.io/onBoarding"}),(n,e)=>{e.redirect("http://do.funation.io")}),a.get("/csrfToken",i,(n,e)=>{e.json({csrfToken:n.csrfToken()})}),n.exports=a},function(n,e,t){const o=t(0).Router(),s=t(2);t(1).config();const a=t(5),i=t(4),{on:r}=t(18),d=a({cookie:!0});var u,c=i.urlencoded({extended:!1});u=s.createConnection({host:"funation.cjw8lfl5dvs6.ap-northeast-2.rds.amazonaws.com",user:"admin",port:"3306",password:"funation1234",database:"funation"});o.get("/checkAdmin",(n,e)=>{u.query("SELECT level FROM users where snsId=?",[n.user.snsId],(n,t)=>{n?console.log(n):e.json({level:t[0].level})})}),o.get("/getSubmitList",(n,e)=>{u.query("SELECT submit_index, submit_accountOwner, submit_giv, snsId, date_format(submit_date, '%Y.%m.%d %H:%i:%s') as submit_date, nick, email, phone_number FROM submit JOIN users where users.snsId = submit.submit_snsId and submit_check=0 ORDER BY submit_date",(n,t)=>{n?console.log(n):e.json({info:t})})}),o.post("/acceptSubmit",(n,e)=>{var t=n.body.reqWallet,o=n.body.reqUser,s=n.body.reqIndex,a=n.body.type,i=new Date,r=i.getTime()+60*i.getTimezoneOffset()*1e3,d=new Date(r+324e5);console.log(a),"1"===a?u.query("SELECT wallet FROM users WHERE snsId = ?",[o],(n,a)=>{if(n)console.log(n);else{var i=a[0].wallet;u.query("SELECT * FROM submit where submit_index = ?",[s],(n,a)=>{if(n)console.log(n);else if(0!==a[0].submit_check)e.redirect("/hidden/admin/hatirubi");else{var r=parseInt(i)+parseInt(t);u.query("UPDATE users SET wallet = ? where snsId = ?",[r,o],(n,a)=>{n?console.log(n):u.query("UPDATE submit SET submit_check=1 WHERE submit_index = ?",[s],(n,s)=>{n?console.log(n):u.query("INSERT INTO wallet_transaction (user_id, wallet_money, wallet_date, description) values (?,?,?,?)",[o,t,d,"기브 충전"],(n,t)=>{n?console.log(n):e.redirect("/hidden/admin/hatirubi")})})})}})}}):u.query("SELECT * from submit where submit_index = ?",[s],(n,t)=>{n?console.log(n):0!==t[0].submit_check?e.redirect("/hidden/admin/hatirubi"):u.query("UPDATE submit SET submit_check = 2 where submit_index = ?",[s],(n,t)=>{n?console.log(n):e.redirect("/hidden/admin/hatirubi")})})}),o.post("/zzim",(function(n,e){if(n.user){var t=n.body.index;u.query("SELECT * FROM zzim_list where user_id = ? and thing_index = ?",[n.user.snsId,t],(function(o,s){0!==s.length?u.query("DELETE FROM zzim_list where user_id = ? and thing_index = ?",[n.user.snsId,t],(function(n,t){n?console.log(n):e.redirect("/giveAndTake")})):u.query("INSERT INTO zzim_list values (?, ?)",[n.user.snsId,t],(function(n,t){n?console.log(n):e.redirect("/giveAndTake")}))}))}else e.redirect("/giveAndTake")})),o.post("/suggestion",c,d,(function(n,e){var t=n.body.content,o=n.body.link,s=new Date,a=s.getTime()+60*s.getTimezoneOffset()*1e3,i=new Date(a+324e5),r=n.body.category;u.query("INSERT INTO suggestion values (?,?,?,?)",[t,o,i,r],(function(n,t){n?console.log(n):e.redirect("/")}))})),o.post("/readAll",c,d,(function(n,e){n.user?u.query("UPDATE user_alarm SET readOrNot=1 where readOrNot=0 and user_id=?",[n.user.snsId],(function(n,t){n?console.log(n):e.redirect("/")})):e.redirect("/")})),o.post("/userCheck",d,(n,e)=>{var t=n.body.agree1,o=n.body.agree2,s="on"===n.body.agree3?1:0,a=n.user.snsId;"on"===t&&"on"===o?u.query("UPDATE users SET user_terms = 1, user_marketing = ? WHERE snsId = ?",[s,a],(n,t)=>{n?console.log(n):e.redirect("/")}):e.redirect("/")}),o.post("/userWantGabang",(n,e)=>{const t=n.body.reqUniv;var o=n.body.answer;const s=n.body.otherOption;var a=new Date,i=a.getTime()+60*a.getTimezoneOffset()*1e3,r=new Date(i+324e5);"ans6"===o&&(o=s),u.query("INSERT INTO gabang_submit (gabang_univ, gabang_relation, gabang_date, gabang_reqUser) values (?,?,?,?)",[t,o,r,n.user.snsId],(n,o)=>{n?console.log(n):"결제후"===t?e.sendStatus(204):e.redirect("/gabang")})}),o.post("/changeNick",c,d,(n,e)=>{var t=n.body.newNick;u.query("UPDATE users SET nick = ? WHERE snsId = ?",[t,n.user.snsId],(n,t)=>{n?console.log(n):e.redirect("/")})}),n.exports=o},function(n,e){n.exports=require("npm")},function(n,e,t){const o=t(0),s=o(),a=o.Router(),i=t(2);t(1).config();const r=t(5),d=t(4),{default:u}=t(20),c=r({cookie:!0});var l,_=d.urlencoded({extended:!1});s.use(d.json()),console.log("배포"),(l=i.createConnection({host:"funation.cjw8lfl5dvs6.ap-northeast-2.rds.amazonaws.com",user:"admin",port:"3306",password:"funation1234",database:"funation"})).connect((function(n){n?console.error("error connecting: "+n.stack):console.log("connected as id"+l.threadId)})),a.get("/fail",(function(n,e){e.json({message:n.query.message,code:n.query.code})})),a.post("/charge",_,c,(function(n,e){var t=n.body.reqMoney,o=n.user.snsId,s=new Date,a=s.getTime()+60*s.getTimezoneOffset()*1e3,i=new Date(a+324e5);l.query("SELECT wallet FROM users where snsId=?",o,(function(n,s){if(n)console.log(n);else{var a=s[0].wallet+t/100;l.query("UPDATE users SET wallet=? where snsId=? ",[a,"reqUser"],(function(n,s){n?console.log(n):l.query("INSERT INTO wallet_transaction (user_id, wallet_money, wallet_date) values(?,?,?)",[o,t,i],(function(n,t){n?console.log(n):e.redirect("/chargeSuccess/")}))}))}}))}));a.post("/saveWalletRecords",(n,e)=>{var t=n.body.reqAccountOwner,o=n.body.reqGiv,s=new Date,a=s.getTime()+60*s.getTimezoneOffset()*1e3,i=new Date(a+324e5);l.query("INSERT INTO submit (submit_snsId, submit_giv, submit_date, submit_accountOwner, submit_check) VALUES (?,?,?,?,?)",[n.user.snsId,o,i,t,0],(n,o)=>{n?console.log(n):""===t?e.redirect("/fail"):e.redirect("/walletCharge")})}),a.post("/continuePayments",_,c,(function(n,e){var t=100*n.body.reqCoin,o=n.user.snsId,s=n.body.reqOrderId,a=n.body.reqSetIndex,i=n.body.reqThingIndex,r=parseInt(n.user.wallet),d=parseInt(r-n.body.reqCoin),u=parseInt(n.body.maxCoin),c=n.body.thing_amount,_=parseInt(c)+1,g=n.body.thing_name,h=new Date,m=h.getTime()+60*h.getTimezoneOffset()*1e3,f=new Date(m+324e5);r-n.body.reqCoin<0?(console.log("잔고부족"),e.redirect("/fail")):t>100*u?(e.redirect("/fail"),console.log("참가할 수 있는 금액보다 클때")):l.query("SELECT thing_target_money, thing_crowd_money FROM donation_thing where thing_index = ?",[i],(function(r,u){if(r)console.log(r);else if(1===u.length)if(t>u[0].thing_target_money-u[0].thing_crowd_money)e.redirect("/fail");else{var c=t+u[0].thing_crowd_money,h=c===u[0].thing_target_money?2:1;2===h&&l.query("UPDATE donation_thing SET thing_status = 2 WHERE thing_index = ? and thing_status = 1",[i],(function(n,e){n?console.log(n):l.query("UPDATE donation_thing SET thing_status = 1 WHERE set_index =? and thing_amount = ?",[a,_],(function(n,e){n?console.log(n):l.query("SELECT user_id, sum(transaction_money) as total from donation_transaction where transaction_thing = ? GROUP BY user_id",[i],(function(n,e){if(n)console.log(n);else{var t=[];for(var o in e)for(var s=e[o].total/100,a=0;a<s;a++)t.push(e[o].user_id);for(var r=t[Math.floor(Math.random()*t.length)],d=Array.from(new Set(t));;){var u=d[Math.floor(Math.random()*d.length)],c=d[Math.floor(Math.random()*d.length)];if(2===d.length){if(c="",r!==u)break;u=d[Math.floor(Math.random()*d.length)]}else{if(r!==u&&r!==c&&u!==c)break;if(r===u&&(u=d[Math.floor(Math.random()*d.length)]),r===c&&(c=d[Math.floor(Math.random()*d.length)]),u===c&&(c=d[Math.floor(Math.random()*d.length)],2===d.length))break}}l.query("INSERT INTO result(result_thing_index, result_winner, result_goods1, result_goods2) VALUES(?,?,?,?)",[i,r,u,c],(function(n,e){if(n)console.log(n);else for(var t in d)l.query("INSERT INTO user_alarm(user_id, alarm_title, alarm_body, alarm_date) VALUES (?,?,?,?)",[d[t],"기부 참여 제품 100% 달성",g,f],(function(n,e){n&&console.log(n)}))}))}}))}))})),l.query("UPDATE donation_thing SET thing_crowd_money = ?, thing_endOrNot=? where thing_index = ?",[c,h,i],(function(a,r){a?console.log(a):l.query("INSERT INTO donation_transaction (user_id, transaction_thing, transaction_money, transaction_date, order_id) values (?,?,?,?,?)",[o,i,t,f,s],(function(t,s){t?console.log(t):l.query("UPDATE users SET wallet = ? where snsId = ?",[d,o],(function(t,o){t?console.log(t):e.redirect(`/success/${n.body.reqOrderId}`)}))}))}))}else e.redirect("/fail")}))})),a.post("/continuePaymentsGabang",_,c,(n,e)=>{var t=100*n.body.reqCoin,o=n.user.snsId,s=n.body.reqOrderId,a=n.body.reqThingIndex,i=parseInt(n.user.wallet),r=parseInt(i-n.body.reqCoin),d=parseInt(n.body.maxCoin),u=new Date,c=u.getTime()+60*u.getTimezoneOffset()*1e3,_=new Date(c+324e5);i-n.body.reqCoin<0?(console.log("잔고부족"),e.redirect("/fail")):t>100*d?(e.redirect("/fail"),console.log("참가할 수 있는 금액보다 클때")):l.query("SELECT thing_target_money, thing_crowd_money FROM donation_thing where thing_index = ?",[a],(i,d)=>{if(i)console.log(i);else if(1===d.length)if(t>d[0].thing_target_money-d[0].thing_crowd_money)e.redirect("/fail");else{var u=t+d[0].thing_crowd_money,c=u===d[0].thing_target_money?4:3;4===c&&l.query("UPDATE donation_thing SET thing_status = 4 WHERE thing_index = ? and thing_status=3",[a],(n,e)=>{n&&console.log(n)}),l.query("UPDATE donation_thing SET thing_crowd_money = ?, thing_endOrNot=? where thing_index=?",[u,c,a],(i,d)=>{i?console.log(i):l.query("INSERT INTO donation_transaction (user_id, transaction_thing, transaction_money, transaction_date, order_id) values (?,?,?,?,?)",[o,a,t,_,s],(t,s)=>{t?console.log(t):l.query("UPDATE users SET wallet = ? where snsId = ?",[r,o],(t,o)=>{t?console.log(t):e.redirect(`/successGabang/${n.body.reqOrderId}`)})})})}else e.redirect("/fail")})}),a.post("/callback",_,async(n,e)=>{var t=n.body.reqGiv,o=n.body.snsId,s=n.body.merchant_uid,a=new Date,i=a.getTime()+60*a.getTimezoneOffset()*1e3,r=new Date(i+324e5);l.query("INSERT INTO iamport (reqUser, reqTime, reqMoney, merchantId) values(?,?,?,?)",[o,r,t,s],(n,t)=>{n?console.log(n):e.sendStatus(204)})}),a.post("/iamportCallback",_,async(n,e)=>{try{console.log("webhook");const{imp_uid:o,merchant_uid:s,status:a}=n.body;if("paid"===a){const n=await u({url:"https://api.iamport.kr/users/getToken",method:"POST",headers:{"Content-Type":"application/json"},data:{imp_key:"7397689687498268",imp_secret:"HvWa7KUT7THJJFmxmRtb9502lz2qjOE1jBbql5ktZ1dJGzh3qKfAQgDbPFB9tgaNRmdcsyGsAUbhtskU"}}),{access_token:a}=n.data.response;var t=(await u({url:`https://api.iamport.kr/payments/${o}`,method:"GET",headers:{Authorization:a}})).data.response.amount/110;l.query("SELECT reqUser, reqMoney FROM iamport WHERE merchantId = ?",[s],(n,o)=>{if(n)console.log("pont1"+n);else{var s=o[0].reqUser;l.query("SELECT wallet FROM users WHERE snsId = ?",[s],(n,o)=>{if(n)console.log("pont2"+n);else{var a=parseInt(o[0].wallet+t);l.query("UPDATE users SET wallet = ? WHERE snsId = ?",[a,s],(n,o)=>{if(n)console.log(n);else{var a=new Date,i=a.getTime()+60*a.getTimezoneOffset()*1e3,r=new Date(i+324e5);l.query("INSERT INTO wallet_transaction (user_id, wallet_money, wallet_date, description) values (?,?,?,?)",[s,t,r,"기브 충전"],(n,t)=>{n?console.log(n):e.sendStatus(204)})}})}})}})}else e.redirect("/")}catch(n){e.status(400).send(n)}}),a.get("/mobileCallback/:amount",_,async(n,e)=>{var t=n.user.snsId,{imp_uid:o,merchant_uid:s}=n.query,a=n.params.amount,i=new Date,r=i.getTime()+60*i.getTimezoneOffset()*1e3,d=new Date(r+324e5);l.query("INSERT INTO iamport (reqUser, reqTime, reqMoney, merchantId) values(?,?,?,?)",[t,d,110*a,s],(n,t)=>{n?console.log(n):e.redirect("/")})}),n.exports=a},function(n,e){n.exports=require("axios")},function(n,e,t){const o=t(0),s=(o(),t(2)),a=o.Router();var i;t(1).config(),(i=s.createConnection({host:"funation.cjw8lfl5dvs6.ap-northeast-2.rds.amazonaws.com",user:"admin",port:"3306",password:"funation1234",database:"funation"})).connect(n=>{n?console.err("error connecting: "+n.stack):console.log("application BackendOn !!"+i.threadId)});a.get("/index",(n,e)=>{e.json({testApi:"for application"})}),n.exports=a},function(n,e,t){"use strict";(function(e){t(23);const o=t(7),s=t(8),a=(o.basename(e),t(24).production),i=t(6),r={},d=new s(a.database,a.username,a.password,a);r.sequelize=d,r.User=i,i.init(d),i.associate(r),n.exports=r}).call(this,"/index.js")},function(n,e){n.exports=require("fs")},function(n,e,t){t(1).config(),n.exports={development:{username:"root",password:"!t1621711",database:"funation",host:{}.LOCAL_MYSQL_HOST,dialect:"mysql"},test:{username:"admin",password:"funation1234",database:"funation",host:"funationtest.c4dshxnf8xym.us-east-1.rds.amazonaws.com",dialect:"mysql"},production:{username:"admin",password:"funation1234",database:"funation",host:"funation.cjw8lfl5dvs6.ap-northeast-2.rds.amazonaws.com",dialect:"mysql",logging:!1}}},function(n,e,t){const o=t(3),s=t(26),a=t(6);n.exports=()=>{o.serializeUser((n,e)=>{e(null,n.id)}),o.deserializeUser((n,e)=>{a.findOne({where:{id:n}}).then(n=>e(null,n)).catch(n=>e(n))}),s()}},function(n,e,t){const o=t(3),s=t(27).Strategy,a=t(6);n.exports=()=>{o.use(new s({clientID:"2be768f9e7bd1b36a47a31f958a38f81",callbackURL:"http://do.funation.io/auth/kakao/callback"},async(n,e,t,o)=>{try{const n=await a.findOne({where:{snsId:t.id,provider:"kakao"}});if(n)o(null,n);else{o(null,await a.create({email:t._json.kakao_account.email,nick:t.displayName,snsId:t.id,provider:"kakao",age_range:t._json.kakao_account.age_range,gender:t._json.kakao_account.gender,phone_number:t._json.kakao_account.phone_number,profile_img:t._json.kakao_account.profile.thumbnail_image_url,created_at:t._json.connected_at,wallet:0,level:"기부니"}))}}catch(n){console.error(n),o(n)}}))}},function(n,e){n.exports=require("passport-kakao")},function(n,e){n.exports=require("helmet")},function(n,e){n.exports=require("hpp")}]);